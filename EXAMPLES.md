# Примеры использования iPhone Power Monitor

## Базовое использование

### 1. Проверка короткого замыкания

```
1. Подключите iPhone к устройству
2. Отправьте команду: ON
3. Наблюдайте за током на дисплее
4. Если ток превышает 1А - устройство автоматически отключится
5. Проверьте соединения и повторите
```

### 2. Мониторинг нормального потребления

```
1. Включите питание: ON
2. Переключитесь в режим графика (кнопка)
3. Наблюдайте за потреблением в реальном времени
4. Нормальное потребление iPhone: 0.1-0.8А в зависимости от режима
```

## Автоматическое управление током

### Ограничение тока зарядки

```
Serial команды:
AUTO                    # Включить автоматический режим
SET_TARGET 0.5          # Установить максимальный ток 0.5А
ON                      # Включить питание
```

Устройство будет автоматически поддерживать ток не выше 0.5А.

### Плавное увеличение тока

```python
# Пример скрипта для плавного увеличения тока
import serial
import time

ser = serial.Serial('COM3', 115200)  # Замените на ваш порт

# Включить автоматический режим
ser.write(b'AUTO\n')
time.sleep(0.1)

# Плавно увеличивать ток от 0.1А до 1.0А
for current in range(100, 1001, 50):  # от 0.1 до 1.0 с шагом 0.05А
    target = current / 1000.0
    command = f'SET_TARGET {target:.3f}\n'
    ser.write(command.encode())
    print(f'Установлен ток: {target:.3f}А')
    time.sleep(2)  # Ждем 2 секунды
    
    # Читаем ответ
    if ser.in_waiting:
        response = ser.readline().decode().strip()
        print(f'Ответ: {response}')

ser.close()
```

## Диагностические сценарии

### 1. Поиск короткого замыкания

```
Алгоритм:
1. OFF                  # Выключить питание
2. SET_TARGET 0.1       # Установить минимальный ток
3. AUTO                 # Автоматический режим
4. ON                   # Включить питание

Если ток сразу превышает 0.1А:
- Есть утечка или КЗ
- Проверьте компоненты по очереди
```

### 2. Тест стабильности питания

```
1. AUTO
2. SET_TARGET 0.8       # Установить рабочий ток
3. ON
4. Переключиться на график
5. Наблюдать в течение 10-15 минут

Нормальное поведение:
- Ток стабилен ±0.05А
- Нет резких скачков
- Температура MOSFET не превышает 60°C
```

### 3. Измерение потребления в разных режимах

```
Режим ожидания:
SET_TARGET 0.2
ON
# Ток должен быть 0.05-0.15А

Режим зарядки:
SET_TARGET 1.0
ON  
# Ток может достигать 0.8-1.0А

Режим восстановления:
SET_TARGET 0.5
ON
# Постепенное увеличение тока
```

## Настройка PID-регулятора

### Для быстрого отклика (агрессивная настройка):
```cpp
pidKp = 150.0;  // Увеличить пропорциональный коэффициент
pidKi = 20.0;   // Увеличить интегральный
pidKd = 2.0;    // Увеличить дифференциальный
```

### Для плавного регулирования (консервативная настройка):
```cpp
pidKp = 50.0;   // Уменьшить пропорциональный коэффициент
pidKi = 5.0;    // Уменьшить интегральный
pidKd = 0.5;    // Уменьшить дифференциальный
```

## Мониторинг через Serial

### Непрерывный мониторинг

```python
import serial
import time
import matplotlib.pyplot as plt
from datetime import datetime

ser = serial.Serial('COM3', 115200)
times = []
currents = []
voltages = []

try:
    while True:
        ser.write(b'STATUS\n')
        time.sleep(0.5)
        
        # Читаем все доступные данные
        while ser.in_waiting:
            line = ser.readline().decode().strip()
            if 'Current:' in line:
                current = float(line.split(':')[1].replace('A', '').strip())
                currents.append(current)
                times.append(datetime.now())
                print(f'{datetime.now()}: {current:.3f}A')
                
        time.sleep(1)
        
except KeyboardInterrupt:
    print("Остановлено пользователем")
    
    # Построить график
    plt.figure(figsize=(12, 6))
    plt.plot(times, currents)
    plt.title('Потребление тока во времени')
    plt.xlabel('Время')
    plt.ylabel('Ток (А)')
    plt.grid(True)
    plt.show()
    
finally:
    ser.close()
```

## Типичные значения тока для iPhone

| Состояние | Ток потребления |
|-----------|----------------|
| Выключен | 0.000-0.005А |
| Режим ожидания | 0.050-0.150А |
| Включение | 0.200-0.500А |
| Нормальная работа | 0.100-0.300А |
| Зарядка (выключен) | 0.500-1.000А |
| Зарядка (включен) | 0.300-0.800А |
| Короткое замыкание | >1.000А |

## Устранение проблем

### Ложные срабатывания защиты:
```
1. Увеличить MAX_CURRENT до 1.2А
2. Добавить задержку перед отключением
3. Проверить качество соединений шунта
```

### Нестабильные показания:
```
1. Увеличить SAMPLES_COUNT до 20
2. Добавить конденсатор 100нФ параллельно шунту
3. Экранировать аналоговые цепи
```

### Медленный отклик PID:
```
1. Уменьшить UPDATE_INTERVAL до 50мс
2. Увеличить pidKp
3. Проверить частоту PWM MOSFET
```